# 钉钉命令参考

## 概述

通过在钉钉群中 @机器人 发送命令，可以触发自动化发布流程。

---

## 命令列表

### 发布相关

#### 发布到指定环境

```
@小龙虾 发布 {产品} {版本} 到 {环境}
```

**示例：**
```
@小龙虾 发布 product-a v1.3.0 到 test-server-01
@小龙虾 发布 user-center v2.0.0 到 staging
```

**参数说明：**
- `产品`: 产品名称
- `版本`: 目标版本号
- `环境`: 目标环境 ID

---

#### 全量发布

```
@小龙虾 全量发布 {产品} {版本} 到 {环境}
```

**示例：**
```
@小龙虾 全量发布 product-a v2.0.0 到 test-server-01
```

---

#### 增量发布

```
@小龙虾 增量发布 {产品} {版本} 到 {环境}
```

**示例：**
```
@小龙虾 增量发布 product-a v1.3.0 到 test-server-01
```

---

### 回滚相关

#### 回滚到指定版本

```
@小龙虾 回滚 {产品} 到 {版本} 在 {环境}
```

**示例：**
```
@小龙虾 回滚 product-a 到 v1.2.0 在 test-server-01
```

---

#### 回滚到上一版本

```
@小龙虾 回滚 {环境} 的 {产品}
```

**示例：**
```
@小龙虾 回滚 test-server-01 的 product-a
```

---

### 查询相关

#### 查看环境版本

```
@小龙虾 查看 {环境} 的版本
```

**示例：**
```
@小龙虾 查看 test-server-01 的版本
```

**返回示例：**
```
📊 test-server-01 (测试环境) 版本信息

| 产品 | 当前版本 | 部署时间 |
|------|----------|----------|
| product-a | v1.3.0 | 2026-01-31 10:30 |
| product-b | v2.1.0 | 2026-01-30 15:20 |
```

---

#### 查看产品版本列表

```
@小龙虾 查看 {产品} 的版本列表
```

**示例：**
```
@小龙虾 查看 product-a 的版本列表
```

**返回示例：**
```
📦 product-a 版本列表

| 版本 | 类型 | 创建时间 | 状态 |
|------|------|----------|------|
| v1.3.0 | 增量 | 2026-01-31 | 活跃 |
| v1.2.0 | 增量 | 2026-01-25 | 活跃 |
| v1.1.0 | 增量 | 2026-01-20 | 活跃 |
| v1.0.0 | 全量 | 2026-01-15 | 活跃 |
```

---

#### 查看部署历史

```
@小龙虾 查看 {环境} 的部署历史
```

**示例：**
```
@小龙虾 查看 test-server-01 的部署历史
```

**返回示例：**
```
📜 test-server-01 最近部署记录

| 时间 | 产品 | 版本 | 结果 | 操作人 |
|------|------|------|------|--------|
| 01-31 10:30 | product-a | v1.3.0 | ✅ 成功 | 张三 |
| 01-30 15:20 | product-b | v2.1.0 | ✅ 成功 | 李四 |
| 01-29 09:15 | product-a | v1.2.0 | ✅ 成功 | 张三 |
```

---

### 构建相关

#### 触发构建

```
@小龙虾 构建 {产品} {版本}
```

**示例：**
```
@小龙虾 构建 product-a v1.3.0
```

---

#### 查看构建状态

```
@小龙虾 查看构建 {产品} {构建号}
```

**示例：**
```
@小龙虾 查看构建 product-a 123
```

---

### 分析相关

#### 分析 SVN 变更

```
@小龙虾 分析 {产品} 从 {版本1} 到 {版本2} 的变更
```

**示例：**
```
@小龙虾 分析 product-a 从 v1.2.0 到 v1.3.0 的变更
```

**返回示例：**
```
📊 product-a 变更分析 (v1.2.0 → v1.3.0)

SVN 版本: r1050 → r1100

变更统计:
• 代码文件: 15 个
• DDL 脚本: 2 个
• DML 脚本: 1 个
• 配置文件: 1 个

涉及模块:
• user-service
• order-service

DDL 变更:
• 001_add_user_index.sql - 添加用户表索引
• 002_add_order_column.sql - 订单表新增字段
```

---

### 环境相关

#### 查看环境列表

```
@小龙虾 查看环境列表
```

**返回示例：**
```
🖥️ 可用环境列表

| 环境ID | 名称 | 类型 | 状态 |
|--------|------|------|------|
| test-server-01 | 测试环境1 | test | 🟢 正常 |
| test-server-02 | 测试环境2 | test | 🟢 正常 |
| staging | 预发布环境 | staging | 🟢 正常 |
| prod-server-01 | 生产环境1 | prod | 🟢 正常 |
```

---

#### 检查环境状态

```
@小龙虾 检查 {环境} 状态
```

**示例：**
```
@小龙虾 检查 test-server-01 状态
```

**返回示例：**
```
🖥️ test-server-01 状态检查

服务器:
• SSH 连接: ✅ 正常
• CPU: 15%
• 内存: 2.1GB / 8GB
• 磁盘: 45GB / 100GB

数据库:
• 连接: ✅ 正常
• 活跃连接: 5

服务状态:
• user-service: 🟢 运行中 (v1.3.0)
• order-service: 🟢 运行中 (v1.3.0)
```

---

## 交互式确认

某些操作需要用户确认：

### 确认部署

```
Agent: ⚠️ 检测到 DDL 变更，是否继续部署？
       回复: 确认 / 取消 / 查看详情

用户: 确认
```

### 查看详情

```
用户: 查看详情

Agent: 📄 DDL 变更详情:

1. 001_add_user_index.sql
   ALTER TABLE t_user ADD INDEX idx_phone (phone);
   预计影响: 无数据变更，仅添加索引

2. 002_add_order_column.sql
   ALTER TABLE t_order ADD COLUMN export_status INT DEFAULT 0;
   预计影响: 新增字段，默认值为 0

是否继续？回复: 确认 / 取消
```

---

## 快捷命令

| 快捷命令 | 完整命令 |
|----------|----------|
| 发布 | 发布 {产品} {版本} 到 {环境} |
| 回滚 | 回滚 {产品} 到上一版本 在 {环境} |
| 状态 | 查看 {环境} 的版本 |
| 历史 | 查看 {环境} 的部署历史 |
| 构建 | 构建 {产品} {版本} |

---

## 权限控制

| 命令类型 | 测试环境 | 预发布环境 | 生产环境 |
|----------|----------|------------|----------|
| 发布 | 所有人 | 需确认 | 需审批 |
| 回滚 | 所有人 | 需确认 | 需审批 |
| 查询 | 所有人 | 所有人 | 所有人 |
| 构建 | 所有人 | 所有人 | 所有人 |

---

## 错误处理

### 常见错误

```
❌ 环境不存在: test-server-03
   可用环境: test-server-01, test-server-02, staging, prod-server-01

❌ 版本不存在: v1.4.0
   product-a 可用版本: v1.3.0, v1.2.0, v1.1.0, v1.0.0

❌ 升级路径无效: v1.0.0 → v1.3.0
   需要先升级到 v1.2.0

❌ 权限不足: 生产环境部署需要审批
   请联系管理员审批后重试
```
