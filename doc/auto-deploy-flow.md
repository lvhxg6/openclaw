# 自动化发布流程设计文档

## 概述

本文档描述了基于 OpenClaw Agent 的自动化发布流程，支持通过钉钉触发 Spring Boot 项目的构建、部署和验证。

## 部署环境范围

```
┌─────────────────────────────────────────────────────────────┐
│  自动化部署目标环境                                           │
├─────────────────────────────────────────────────────────────┤
│  ✅ 开发环境 (dev)    - 支持自动部署                          │
│  ✅ 测试环境 (test)   - 支持自动部署                          │
│  ❌ 生产环境 (prod)   - 不在自动化范围内，需人工操作            │
└─────────────────────────────────────────────────────────────┘
```

## 支持的数据库类型

产品支持多种国产/开源数据库，发布包需要包含各数据库类型对应的 SQL 脚本：

| 数据库类型 | 标识 | 说明 |
|-----------|------|------|
| OpenGauss | `opengauss` | 华为开源数据库 |
| GreatDB | `greatdb` | 万里数据库 |
| GoldenDB | `goldendb` | 中兴分布式数据库 |
| 盘维数据库 | `panwei` | 盘维数据库 |
| PostgreSQL | `pg` | 开源 PostgreSQL |

## 整体架构

```
┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────┐
│  钉钉群   │───▶│  OpenClaw    │───▶│   Jenkins    │───▶│  服务器   │
│  触发     │    │  Agent       │    │   构建       │    │  部署     │
└──────────┘    └──────────────┘    └──────────────┘    └──────────┘
                       │
                       ▼
                ┌──────────────┐
                │  SVN 仓库    │
                │  分析变更    │
                └──────────────┘
                       │
                       ▼
                ┌──────────────┐
                │  发布包生成   │
                │  jar+sql+cfg │
                └──────────────┘
```

## 触发方式

在钉钉群中 @机器人 发送命令：

```
# 增量部署
@小龙虾 发布 product-a v1.3.0-beta4 到 test-server-01

# 全量部署
@小龙虾 全量部署 product-a v1.3.0-beta4 到 test-server-02 新建数据库
```

---

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           完整发布流程                                                    │
│                                                                                         │
│  触发方式: @小龙虾 发布 product-a v1.3.0-beta4 到 test-server-01                         │
│  部署环境: 开发环境 / 测试环境 (生产环境不支持自动部署)                                    │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 阶段零: 版本阶段判断 + 打包策略                                                    │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                 │   │
│  │  0.1 版本发布流程                                                                │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  beta1 → beta2 → beta3 → beta4 → beta5 → rc1 → rc2 → final              │   │   │
│  │  │    │       │       │       │       │      │     │      │                │   │   │
│  │  │    └───────┴───────┘       └───────┴──────┴─────┴──────┘                │   │   │
│  │  │      仅增量包                    增量包 + 全量包                          │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                 │   │
│  │  0.2 打包策略判断                                                                │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  ┌─────────────────────┐                                                │   │   │
│  │  │  │ 版本阶段是什么？     │                                                │   │   │
│  │  │  └──────────┬──────────┘                                                │   │   │
│  │  │       ┌─────┴─────┐                                                     │   │   │
│  │  │       ▼           ▼                                                     │   │   │
│  │  │  [beta1-3]    [beta4+/rc/final]                                         │   │   │
│  │  │       │           │                                                     │   │   │
│  │  │       ▼           ▼                                                     │   │   │
│  │  │  ┌─────────┐  ┌─────────────────┐                                       │   │   │
│  │  │  │ 仅增量包 │  │ 增量包 + 全量包  │                                       │   │   │
│  │  │  └─────────┘  └─────────────────┘                                       │   │   │
│  │  │                                                                         │   │   │
│  │  │  增量包基线: 始终基于上一个 final 版本 (如 v1.2.0)                        │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                 │   │
│  │  0.3 部署类型判断                                                                │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  ┌─────────────────┐                                                    │   │   │
│  │  │  │ 用户指定类型？   │                                                    │   │   │
│  │  │  └────────┬────────┘                                                    │   │   │
│  │  │     ┌─────┴─────┐                                                       │   │   │
│  │  │     ▼           ▼                                                       │   │   │
│  │  │   [是]        [否] → 目标环境有版本? → [否]全量 / [是]增量               │   │   │
│  │  │     │                                                                   │   │   │
│  │  │     ▼                                                                   │   │   │
│  │  │  ┌──────────────────────┐  ┌──────────────────────┐                     │   │   │
│  │  │  │      📦 全量部署      │  │      📦 增量部署      │                     │   │   │
│  │  │  ├──────────────────────┤  ├──────────────────────┤                     │   │   │
│  │  │  │ • 新建/恢复数据库    │  │ • 已有环境升级        │                     │   │   │
│  │  │  │ • 全量建表 SQL       │  │ • 增量 DDL/DML       │                     │   │   │
│  │  │  │ • 全量初始化数据     │  │ • 配置差异合并       │                     │   │   │
│  │  │  │ • 所有 jar 包        │  │ • 变更的 jar 包      │                     │   │   │
│  │  │  └──────────────────────┘  └──────────────────────┘                     │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                        ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 阶段一: 构建打包 (多数据库支持)                                                    │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                 │   │
│  │  1.1 版本分析                                                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │ • 解析版本号: v1.3.0-beta4 → 版本阶段: beta4                              │   │   │
│  │  │ • 确定打包策略: beta4 → 需要打增量包 + 全量包                              │   │   │
│  │  │ • 确定增量基线: v1.2.0 (上一个 final)                                      │   │   │
│  │  │ • 获取 SVN 变更范围                                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  1.2 变更分析 + Jenkins 构建                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │ • 分析 SVN 变更: 代码 / DDL / DML / 配置                                   │   │   │
│  │  │ • 触发 Jenkins 构建，等待完成，下载 jar 包                                 │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  1.3 组装发布包 (SQL 按数据库类型分目录)                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  sql/                                                                   │   │   │
│  │  │  ├── opengauss/{full,incremental,rollback}/   (华为 OpenGauss)          │   │   │
│  │  │  ├── greatdb/{full,incremental,rollback}/     (万里数据库)              │   │   │
│  │  │  ├── goldendb/{full,incremental,rollback}/    (中兴分布式)              │   │   │
│  │  │  ├── panwei/{full,incremental,rollback}/      (盘维数据库)              │   │   │
│  │  │  └── pg/{full,incremental,rollback}/          (PostgreSQL)              │   │   │
│  │  │                                                                         │   │   │
│  │  │  【beta1-3】仅增量包        【beta4+】增量包 + 全量包                     │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                 │   │
│  │  📦 产出: /releases/product-a/v1.3.0-beta4/{incremental,full}/                  │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                        ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 阶段二: 部署                                                                      │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                 │   │
│  │  2.1 预检查                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │ □ SSH 连通性  □ 数据库连通性 + 类型确认 (opengauss/greatdb/...)          │   │   │
│  │  │ □ 发布包支持该数据库类型  □ 磁盘空间  □ 当前版本                          │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  2.2 数据库准备                                                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  【增量部署】                          【全量部署】                        │   │   │
│  │  │  • 备份当前 jar/配置/数据库            • 新建空数据库  或                 │   │   │
│  │  │                                       • 恢复数据库备份  或               │   │   │
│  │  │                                       • 清空现有数据库                   │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  2.3 停止服务 → 2.4 执行 SQL (根据数据库类型选目录) → 2.5 部署 jar → 2.6 启动   │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  数据库类型: OpenGauss → sql/opengauss/{incremental|full}/              │   │   │
│  │  │  客户端工具: gsql / mysql / psql / pwcli (根据类型)                      │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                        ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 阶段三: 验证                                                                      │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                 │   │
│  │  【增量验证重点】                         【全量验证重点】                        │   │
│  │  ┌───────────────────────────────┐      ┌───────────────────────────────┐      │   │
│  │  │ □ 增量 SQL 执行正确            │      │ □ 全量 SQL 执行正确            │      │   │
│  │  │ □ 原有数据未丢失               │      │ □ 初始化数据完整               │      │   │
│  │  │ □ 新旧功能兼容                 │      │ □ 服务正常启动                 │      │   │
│  │  │ □ 配置合并正确                 │      │ □ 基础功能可用                 │      │   │
│  │  └───────────────────────────────┘      └───────────────────────────────┘      │   │
│  │                                                                                 │   │
│  │  通用: □ /actuator/health UP  □ 版本号正确  □ 启动日志无 ERROR                  │   │
│  │  ⚠️ 验证失败 → 自动回滚 → 通知                                                  │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                        ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 阶段四: 报告 + 通知                                                               │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  • 生成部署报告 (产品/版本/环境/数据库类型/部署类型/结果)                         │   │
│  │  • 钉钉群通知 + 私聊通知操作人                                                   │   │
│  │  • 更新版本记录数据库                                                            │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 验证环境规划

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           验证环境规划                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  beta1 ~ beta3 阶段: 仅增量验证                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  测试环境 A (增量验证):                                                          │   │
│  │    v1.2.0 → beta1 → beta2 → beta3                                               │   │
│  │    持续在同一环境上进行增量升级验证                                               │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  beta4 ~ final 阶段: 增量 + 全量 同时验证                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  测试环境 A (增量验证):                                                          │   │
│  │    ... → beta3 → beta4 → beta5 → rc1 → rc2 → final                              │   │
│  │                                                                                 │   │
│  │  测试环境 B (全量验证):                                                          │   │
│  │    beta4: 空库/恢复库 → 全量部署 → 验证 → 清理                                   │   │
│  │    beta5: 空库/恢复库 → 全量部署 → 验证 → 清理                                   │   │
│  │    rc1~final: 同上                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 钉钉交互示例

```
👤 用户: @小龙虾 发布 product-a v1.3.0 到 test-server-01

🦞 Agent: 收到，开始部署 product-a v1.3.0 到测试环境1

📋 预检查:
  ✅ 服务器 192.168.1.100 连通
  ✅ 数据库 192.168.1.101 连通
  ✅ 当前版本: v1.2.0
  ✅ 升级包存在: /releases/product-a/incremental/v1.2.0-v1.3.0/

📦 升级内容:
  • JAR: user-service-1.3.0.jar
  • DDL: 1 个文件 (001_add_index.sql)
  • DML: 无
  • 配置: application.yml 有变更

是否继续部署？(确认/取消/查看SQL)

👤 用户: 确认

🦞 Agent: 
🚀 开始部署...

[1/6] 备份中...
  ✅ 备份 jar: /backup/20260131/user-service-1.2.0.jar
  ✅ 备份配置: /backup/20260131/application.yml

[2/6] 停止服务...
  ✅ user-service 已停止

[3/6] 执行 SQL...
  ✅ 001_add_index.sql 执行成功 (0.3s)

[4/6] 部署新版本...
  ✅ 上传 user-service-1.3.0.jar
  ✅ 更新 application.yml

[5/6] 启动服务...
  ✅ user-service 已启动

[6/6] 验证...
  ✅ 健康检查通过
  ✅ 版本确认: v1.3.0

🎉 部署成功！

📊 部署报告:
  • 环境: test-server-01
  • 版本: v1.2.0 → v1.3.0
  • 耗时: 45s
  • 服务地址: http://192.168.1.100:8080
```

---

## 阶段一：构建打包

### 1.1 版本分析

- 查询目标环境当前版本
- 确定升级类型（增量/全量）
- 获取 SVN 变更范围

### 1.2 变更分析

- 分析 SVN 变更文件列表
- 分类：代码变更 / DDL / DML / 配置
- 识别影响的服务模块
- 生成变更清单

### 1.3 触发 Jenkins 构建

- 调用 Jenkins API 触发构建
- 传递参数：版本号、模块列表、SVN revision
- 等待构建完成
- 下载构建产物（jar 包）

### 1.4 组装发布包

- 创建发布包目录结构
- 复制 jar 包到 `jars/`
- 收集 SQL 文件到 `sql/ddl/` 和 `sql/dml/`
- 生成配置差异文件到 `config/`
- 生成 `CHANGELOG.md`
- 生成 `release-manifest.json`
- 打包：`release-v1.3.0-20260131.tar.gz`
- 存储到发布包仓库

**产出**：`release-v1.3.0-20260131.tar.gz`

---

## 阶段二：部署

### 2.1 预检查

| 检查项 | 说明 |
|--------|------|
| SSH 连通性 | 目标服务器可访问 |
| 数据库连通性 | 目标数据库可连接 |
| 磁盘空间 | 剩余空间 > 1GB |
| 服务状态 | 当前服务运行状态 |
| 版本确认 | 当前版本号 |
| 升级路径 | 版本可升级性验证 |

### 2.2 备份

- 备份当前 jar 包
- 备份当前配置文件
- 备份数据库（可选：全库 / 仅变更表 / 跳过）
- 记录备份路径到部署日志

### 2.3 停止服务

- 发送停止信号（SIGTERM）
- 等待优雅关闭（最长 60s）
- 确认进程已退出
- 确认端口已释放

### 2.4 执行数据库变更

- 按序号执行 DDL 脚本
- 按序号执行 DML 脚本
- 记录每个脚本执行结果和耗时
- 失败时立即停止并回滚

### 2.5 部署应用

- 上传新版本 jar 包
- 更新配置文件（合并差异）
- 设置文件权限
- 更新软链接（如有）

### 2.6 启动服务

- 执行启动脚本
- 等待服务启动（最长 120s）
- 检查进程是否存在
- 检查端口是否监听

---

## 阶段三：验证

### 3.1 基础健康检查

| 检查项 | 说明 |
|--------|------|
| /actuator/health | 返回 UP |
| /actuator/info | 版本号正确 |
| 数据库连接池 | 连接正常 |
| Redis 连接 | 连接正常（如有） |
| 消息队列连接 | 连接正常（如有） |

### 3.2 接口验证（可选）

- 核心接口可访问性测试
- 登录接口测试
- 关键业务接口冒烟测试

### 3.3 数据验证（可选）

- 新增表/字段存在性检查
- 索引创建成功检查
- 初始化数据检查

### 3.4 日志检查

- 启动日志无 ERROR
- 无异常堆栈
- 关键组件初始化成功

**失败处理**：验证失败 → 自动回滚 → 通知

---

## 阶段四：报告

### 4.1 生成部署报告

报告包含以下内容：

- **基本信息**：产品、版本、环境、时间、结果
- **部署内容**：JAR 包、DDL/DML 脚本、配置变更
- **执行时间线**：各阶段开始/结束时间
- **验证结果**：各项检查结果
- **变更日志**：本次版本变更内容
- **相关链接**：Jenkins、服务地址、备份位置
- **回滚说明**：回滚命令和注意事项

### 4.2 发送通知

- 钉钉群通知（简要版）
- 钉钉私聊通知操作人（详细版）
- 邮件通知（可选）
- 更新版本记录数据库

### 4.3 归档

- 保存部署报告到文件
- 记录部署历史
- 清理临时文件

---

## 多数据库支持设计

### 数据库类型与 SQL 兼容性

由于产品需要支持多种数据库，SQL 脚本存在语法差异，需要按数据库类型分别维护：

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           多数据库 SQL 差异示例                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  功能: 添加字段                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  PostgreSQL / OpenGauss:                                                        │   │
│  │    ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);                │   │
│  │                                                                                 │   │
│  │  GreatDB / GoldenDB (MySQL 兼容):                                               │   │
│  │    ALTER TABLE users ADD COLUMN phone VARCHAR(20);                              │   │
│  │                                                                                 │   │
│  │  盘维数据库:                                                                     │   │
│  │    ALTER TABLE users ADD phone VARCHAR2(20);                                    │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  功能: 创建索引                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  PostgreSQL / OpenGauss:                                                        │   │
│  │    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_phone ON users(phone);      │   │
│  │                                                                                 │   │
│  │  GreatDB / GoldenDB:                                                            │   │
│  │    CREATE INDEX idx_user_phone ON users(phone);                                 │   │
│  │                                                                                 │   │
│  │  盘维数据库:                                                                     │   │
│  │    CREATE INDEX idx_user_phone ON users(phone) ONLINE;                          │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 发布包 SQL 目录结构

```
release-v1.3.0-20260131/
├── jars/
│   └── user-service-1.3.0.jar
├── sql/
│   ├── opengauss/                    # OpenGauss 数据库
│   │   ├── full/                     # 全量脚本
│   │   │   ├── ddl/
│   │   │   │   ├── 001_create_user.sql
│   │   │   │   └── 002_create_order.sql
│   │   │   └── dml/
│   │   │       ├── 001_init_config.sql
│   │   │       └── 002_init_dict.sql
│   │   ├── incremental/              # 增量脚本
│   │   │   ├── ddl/
│   │   │   │   └── 001_add_phone_column.sql
│   │   │   └── dml/
│   │   │       └── 001_update_config.sql
│   │   └── rollback/                 # 回滚脚本
│   │       └── 001_rollback_phone_column.sql
│   │
│   ├── greatdb/                      # GreatDB (万里数据库)
│   │   ├── full/
│   │   │   ├── ddl/
│   │   │   └── dml/
│   │   ├── incremental/
│   │   │   ├── ddl/
│   │   │   └── dml/
│   │   └── rollback/
│   │
│   ├── goldendb/                     # GoldenDB (中兴分布式)
│   │   ├── full/
│   │   ├── incremental/
│   │   └── rollback/
│   │
│   ├── panwei/                       # 盘维数据库
│   │   ├── full/
│   │   ├── incremental/
│   │   └── rollback/
│   │
│   └── pg/                           # PostgreSQL
│       ├── full/
│       ├── incremental/
│       └── rollback/
│
├── config/
├── scripts/
├── CHANGELOG.md
└── release-manifest.json
```

### release-manifest.json 示例

```json
{
  "product": "product-a",
  "version": "1.3.0",
  "releaseType": "incremental",
  "fromVersion": "1.2.0",
  "buildTime": "2026-01-31T10:30:00Z",
  "jenkinsJob": "product-a-build",
  "jenkinsBuild": 123,
  "svnRevision": {
    "from": 1050,
    "to": 1100
  },
  "databases": {
    "supported": ["opengauss", "greatdb", "goldendb", "panwei", "pg"],
    "sqlStats": {
      "opengauss": {
        "full": { "ddl": 2, "dml": 2 },
        "incremental": { "ddl": 1, "dml": 1 },
        "rollback": 1
      },
      "greatdb": {
        "full": { "ddl": 2, "dml": 2 },
        "incremental": { "ddl": 1, "dml": 1 },
        "rollback": 1
      }
    }
  },
  "jars": [
    { "name": "user-service-1.3.0.jar", "module": "user-service", "size": 28000000 }
  ],
  "configChanges": [
    { "file": "application.yml", "type": "modified" }
  ],
  "changelog": [
    "feat: 用户表增加手机号字段",
    "fix: 修复订单查询性能问题"
  ]
}
```

### 数据库类型选择流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           数据库类型选择流程                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                                 │   │
│  │  1. 从环境配置获取数据库类型                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  environments.json:                                                     │   │   │
│  │  │  {                                                                      │   │   │
│  │  │    "test-server-01": {                                                  │   │   │
│  │  │      "db": {                                                            │   │   │
│  │  │        "type": "opengauss",        ← 数据库类型                          │   │   │
│  │  │        "host": "192.168.1.101",                                         │   │   │
│  │  │        "port": 5432,                                                    │   │   │
│  │  │        "database": "product_a"                                          │   │   │
│  │  │      }                                                                  │   │   │
│  │  │    }                                                                    │   │   │
│  │  │  }                                                                      │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  2. 验证发布包支持该数据库类型                                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  检查 release-manifest.json:                                            │   │   │
│  │  │    databases.supported 是否包含 "opengauss"                              │   │   │
│  │  │                                                                         │   │   │
│  │  │  ✅ 包含 → 继续                                                          │   │   │
│  │  │  ❌ 不包含 → 报错: "发布包不支持 opengauss 数据库"                         │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  3. 选择对应的 SQL 目录                                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  增量发布:                                                               │   │   │
│  │  │    sql/opengauss/incremental/ddl/*.sql                                  │   │   │
│  │  │    sql/opengauss/incremental/dml/*.sql                                  │   │   │
│  │  │                                                                         │   │   │
│  │  │  全量发布:                                                               │   │   │
│  │  │    sql/opengauss/full/ddl/*.sql                                         │   │   │
│  │  │    sql/opengauss/full/dml/*.sql                                         │   │   │
│  │  │                                                                         │   │   │
│  │  │  回滚脚本:                                                               │   │   │
│  │  │    sql/opengauss/rollback/*.sql                                         │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                              ▼                                                  │   │
│  │  4. 使用对应的数据库客户端执行                                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  opengauss / pg  → gsql / psql                                          │   │   │
│  │  │  greatdb         → mysql                                                │   │   │
│  │  │  goldendb        → mysql (分布式模式)                                    │   │   │
│  │  │  panwei          → 盘维客户端                                            │   │   │
│  │  └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 数据库客户端映射

| 数据库类型 | 客户端工具 | 连接命令示例 |
|-----------|-----------|-------------|
| opengauss | gsql | `gsql -h host -p 5432 -U user -d db -f script.sql` |
| pg | psql | `psql -h host -p 5432 -U user -d db -f script.sql` |
| greatdb | mysql | `mysql -h host -P 3306 -u user -p db < script.sql` |
| goldendb | mysql | `mysql -h host -P 3306 -u user -p db < script.sql` |
| panwei | pwcli | `pwcli -h host -p port -u user -d db -f script.sql` |

### SQL 脚本命名规范

```
{序号}_{操作类型}_{对象名}.sql

示例:
  001_create_table_users.sql        # 创建用户表
  002_create_table_orders.sql       # 创建订单表
  001_alter_table_users_add_phone.sql   # 用户表增加手机号字段
  001_insert_init_config.sql        # 初始化配置数据
  001_rollback_users_phone.sql      # 回滚手机号字段
```

### SQL 脚本执行顺序

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           SQL 执行顺序                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  【全量发布】                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  1. 执行 full/ddl/*.sql (按序号升序)                                             │   │
│  │     001_create_table_users.sql                                                  │   │
│  │     002_create_table_orders.sql                                                 │   │
│  │     003_create_table_products.sql                                               │   │
│  │                              ▼                                                  │   │
│  │  2. 执行 full/dml/*.sql (按序号升序)                                             │   │
│  │     001_insert_init_config.sql                                                  │   │
│  │     002_insert_init_dict.sql                                                    │   │
│  │     003_insert_init_admin.sql                                                   │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  【增量发布】                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  1. 执行 incremental/ddl/*.sql (按序号升序)                                      │   │
│  │     001_alter_table_users_add_phone.sql                                         │   │
│  │     002_create_index_users_phone.sql                                            │   │
│  │                              ▼                                                  │   │
│  │  2. 执行 incremental/dml/*.sql (按序号升序)                                      │   │
│  │     001_update_config_version.sql                                               │   │
│  │     002_insert_new_dict.sql                                                     │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  【回滚】                                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  执行 rollback/*.sql (按序号降序 - 逆向回滚)                                      │   │
│  │     002_rollback_index_users_phone.sql                                          │   │
│  │     001_rollback_users_phone.sql                                                │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 钉钉交互示例（多数据库）

```
👤 用户: @小龙虾 发布 product-a v1.3.0 到 test-server-01

🦞 Agent: 收到，开始部署 product-a v1.3.0 到测试环境1

📋 环境信息:
  • 服务器: 192.168.1.100
  • 数据库类型: OpenGauss
  • 数据库地址: 192.168.1.101:5432

📋 预检查:
  ✅ 服务器 SSH 连通
  ✅ 数据库 OpenGauss 连通
  ✅ 当前版本: v1.2.0
  ✅ 发布包支持 OpenGauss: 是

📦 升级内容 (增量):
  • JAR: user-service-1.3.0.jar
  • DDL (OpenGauss): 2 个文件
    - 001_alter_table_users_add_phone.sql
    - 002_create_index_users_phone.sql
  • DML (OpenGauss): 1 个文件
    - 001_update_config_version.sql
  • 配置: application.yml 有变更

是否继续部署？(确认/取消/查看SQL)

👤 用户: 查看SQL

🦞 Agent: 
📄 DDL 脚本内容:

-- 001_alter_table_users_add_phone.sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);

-- 002_create_index_users_phone.sql  
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_phone ON users(phone);

📄 DML 脚本内容:

-- 001_update_config_version.sql
UPDATE sys_config SET value = '1.3.0' WHERE key = 'system.version';

是否继续部署？(确认/取消)

👤 用户: 确认

🦞 Agent: 
🚀 开始部署...

[3/6] 执行 SQL (OpenGauss)...
  ✅ 001_alter_table_users_add_phone.sql 执行成功 (0.2s)
  ✅ 002_create_index_users_phone.sql 执行成功 (1.5s)
  ✅ 001_update_config_version.sql 执行成功 (0.1s)

...
```

---

## 增量 vs 全量

### 判断标准

| 类型 | 触发条件 | 包含内容 |
|------|----------|----------|
| 全量 | 首次部署、大版本升级、指定全量 | 所有 jar + 全量 SQL + 完整配置 |
| 增量 | 常规迭代、bug 修复 | 变更的 jar + 增量 SQL + 配置差异 |

### 自动判断逻辑

1. **版本号判断**
   - v1.x.0 → v2.0.0（主版本变化）→ 全量
   - v1.2.x → v1.3.0（次版本变化）→ 可能全量
   - v1.2.3 → v1.2.4（补丁版本）→ 增量

2. **变更内容判断**
   - 有 DDL 变更 → 需要特别标注
   - 核心表结构变更 → 建议全量
   - 只有 DML 或代码变更 → 增量

3. **人工指定**
   - 通过钉钉命令指定：`@机器人 全量发布 v1.3.0`

---

## 版本发布策略

### 版本发布流程

产品版本发布遵循以下流程：

```
v1.3.0-beta1 → beta2 → beta3 → beta4 → beta5 → rc1 → rc2 → v1.3.0 (final)
     │           │        │        │        │       │      │         │
     └───────────┴────────┴────────┴────────┴───────┴──────┴─────────┘
              开发迭代阶段              稳定验证阶段           正式发布
```

### 打包策略

根据版本阶段采用不同的打包策略：

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           版本阶段打包策略                                                │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  版本阶段          打包内容              说明                                             │
│  ─────────────────────────────────────────────────────────────────────────────────────  │
│  beta1 ~ beta3    仅增量包              快速迭代阶段，功能变动频繁                         │
│  beta4 ~ beta5    增量包 + 全量包       功能基本稳定，开始准备全量包                       │
│  rc1 ~ rc2        增量包 + 全量包       候选发布版本，全面验证                            │
│  final            增量包 + 全量包       正式发布版本                                      │
│                                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  增量包基线: 始终基于上一个 final 版本 (如 v1.2.0)                                        │
│                                                                                         │
│  示例:                                                                                   │
│    v1.3.0-beta1 增量包 → 基于 v1.2.0                                                    │
│    v1.3.0-beta2 增量包 → 基于 v1.2.0 (不是基于 beta1)                                   │
│    v1.3.0-beta3 增量包 → 基于 v1.2.0                                                    │
│    v1.3.0-rc1 增量包   → 基于 v1.2.0                                                    │
│    v1.3.0 final 增量包 → 基于 v1.2.0                                                    │
│                                                                                         │
│  优点: 支持从任意 beta/rc 版本直接升级，无需按顺序逐版本升级                               │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### beta1-3 期间新环境部署

如果在 beta1-3 期间需要搭建新的测试环境：

```
方案: 使用上一个 final 版本的全量包 + 当前 beta 的增量包

步骤:
  1. 部署 v1.2.0 全量包 (上一个 final)
  2. 部署 v1.3.0-beta2 增量包 (当前版本)

结果: 新环境运行 v1.3.0-beta2
```

---

## 增量/全量验证策略

增量包和全量包的验证方式不同，需要分别进行验证。

### 验证方式对比

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           增量/全量验证方式对比                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌───────────────────────────────────┐  ┌───────────────────────────────────┐          │
│  │         增量包验证                 │  │         全量包验证                 │          │
│  ├───────────────────────────────────┤  ├───────────────────────────────────┤          │
│  │                                   │  │                                   │          │
│  │  前提条件:                         │  │  前提条件:                         │          │
│  │  • 需要已有环境                    │  │  • 可以是全新环境                  │          │
│  │  • 环境运行上一个版本              │  │  • 空数据库或恢复的数据库          │          │
│  │                                   │  │                                   │          │
│  │  验证步骤:                         │  │  验证步骤:                         │          │
│  │  1. 在已有环境执行增量升级         │  │  1. 准备空服务器                   │          │
│  │  2. 执行增量 DDL/DML              │  │  2. 新建数据库 或 恢复数据库备份   │          │
│  │  3. 部署变更的 jar 包             │  │  3. 执行全量 DDL (建表)            │          │
│  │  4. 合并配置差异                  │  │  4. 执行全量 DML (初始化数据)      │          │
│  │  5. 重启服务                      │  │  5. 部署所有 jar 包                │          │
│  │  6. 验证升级后功能                │  │  6. 部署完整配置文件               │          │
│  │                                   │  │  7. 启动服务                       │          │
│  │  验证重点:                         │  │  8. 验证全新部署功能               │          │
│  │  • 增量 SQL 执行正确              │  │                                   │          │
│  │  • 数据迁移无丢失                 │  │  验证重点:                         │          │
│  │  • 新旧功能兼容                   │  │  • 全量 SQL 执行正确              │          │
│  │  • 配置合并正确                   │  │  • 初始化数据完整                 │          │
│  │                                   │  │  • 服务正常启动                   │          │
│  │                                   │  │  • 基础功能可用                   │          │
│  │                                   │  │                                   │          │
│  └───────────────────────────────────┘  └───────────────────────────────────┘          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 验证环境规划

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           验证环境规划                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  beta1 ~ beta3 阶段:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  测试环境 A (增量验证):                                                          │   │
│  │    v1.2.0 → beta1 → beta2 → beta3                                               │   │
│  │    持续在同一环境上进行增量升级验证                                               │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  beta4 ~ final 阶段:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  测试环境 A (增量验证):                                                          │   │
│  │    ... → beta3 → beta4 → beta5 → rc1 → rc2 → final                              │   │
│  │    继续增量升级验证                                                              │   │
│  │                                                                                 │   │
│  │  测试环境 B (全量验证):                                                          │   │
│  │    每个版本独立验证全量部署:                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────────────┐     │   │
│  │    │  beta4:  空库 → 全量部署 → 验证 → 清理                               │     │   │
│  │    │  beta5:  空库 → 全量部署 → 验证 → 清理                               │     │   │
│  │    │  rc1:    空库 → 全量部署 → 验证 → 清理                               │     │   │
│  │    │  rc2:    空库 → 全量部署 → 验证 → 清理                               │     │   │
│  │    │  final:  空库 → 全量部署 → 验证 → 保留                               │     │   │
│  │    └─────────────────────────────────────────────────────────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 全量验证的数据库准备

全量验证时，数据库可以采用以下方式准备：

| 方式 | 说明 | 适用场景 |
|------|------|----------|
| 新建空库 | 创建全新的空数据库 | 验证全量建表脚本 |
| 恢复备份 | 从生产/测试环境恢复数据库备份 | 验证全量脚本对已有数据的兼容性 |
| 清空重建 | 删除所有表后重新执行全量脚本 | 快速重置测试环境 |

### 验证检查清单

#### 增量验证检查清单

```
□ 增量 DDL 执行成功
  □ 新增字段存在
  □ 新增索引存在
  □ 表结构变更正确

□ 增量 DML 执行成功
  □ 配置数据更新正确
  □ 字典数据新增正确

□ 数据兼容性
  □ 原有数据未丢失
  □ 数据格式转换正确

□ 功能验证
  □ 原有功能正常
  □ 新增功能可用
  □ 接口兼容性正常
```

#### 全量验证检查清单

```
□ 全量 DDL 执行成功
  □ 所有表创建成功
  □ 所有索引创建成功
  □ 外键约束正确

□ 全量 DML 执行成功
  □ 初始化配置数据完整
  □ 字典数据完整
  □ 默认管理员账号可用

□ 服务启动
  □ 服务正常启动
  □ 无启动错误日志
  □ 健康检查通过

□ 基础功能
  □ 登录功能正常
  □ 核心业务流程可用
```

### 钉钉命令示例

```
# 增量验证
@小龙虾 增量部署 product-a v1.3.0-beta4 到 test-server-01

# 全量验证
@小龙虾 全量部署 product-a v1.3.0-beta4 到 test-server-02

# 全量验证 (新建数据库)
@小龙虾 全量部署 product-a v1.3.0-beta4 到 test-server-02 新建数据库

# 全量验证 (恢复数据库)
@小龙虾 全量部署 product-a v1.3.0-beta4 到 test-server-02 恢复数据库 backup-20260130
```

---

## 环境配置示例

### environments.json

```json
{
  "dev-server-01": {
    "name": "开发环境1",
    "type": "dev",
    "ssh": {
      "host": "192.168.1.10",
      "port": 22,
      "user": "deploy"
    },
    "db": {
      "type": "opengauss",
      "host": "192.168.1.11",
      "port": 5432,
      "database": "product_a_dev",
      "user": "app_user"
    },
    "app": {
      "path": "/opt/apps/product-a",
      "port": 8080,
      "jvmOpts": "-Xms512m -Xmx1024m"
    }
  },
  "test-server-01": {
    "name": "测试环境1",
    "type": "test",
    "ssh": {
      "host": "192.168.1.100",
      "port": 22,
      "user": "deploy"
    },
    "db": {
      "type": "greatdb",
      "host": "192.168.1.101",
      "port": 3306,
      "database": "product_a_test",
      "user": "app_user"
    },
    "app": {
      "path": "/opt/apps/product-a",
      "port": 8080,
      "jvmOpts": "-Xms1024m -Xmx2048m"
    }
  },
  "test-server-02": {
    "name": "测试环境2 (GoldenDB)",
    "type": "test",
    "ssh": {
      "host": "192.168.1.110",
      "port": 22,
      "user": "deploy"
    },
    "db": {
      "type": "goldendb",
      "host": "192.168.1.111",
      "port": 3306,
      "database": "product_a_test",
      "user": "app_user"
    },
    "app": {
      "path": "/opt/apps/product-a",
      "port": 8080
    }
  }
}
```

---

## 下一步

- [发布包结构规范](./release-package-structure.md)
- [环境配置说明](./environment-config.md)
- [Skill 设计文档](./skills-design.md)
- [数据模型设计](./data-model.md)
